<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>minigame-æ°´æºæ¢æµ‹</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #1a5c6c, #1a6c5c);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #4fc3f7;
            text-shadow: 0 0 10px rgba(79, 195, 247, 0.7);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #bbbbbb;
            margin-bottom: 20px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            background: rgba(30, 30, 60, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .info-card {
            background: rgba(25, 25, 50, 0.9);
            padding: 15px;
            border-radius: 8px;
            width: 48%;
        }
        
        .info-card h3 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        button {
            background: linear-gradient(to right, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(33, 150, 243, 0.6);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        /* å°æ¸¸æˆè¦†ç›–å±‚æ ·å¼ */
        #minigame-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
        }
        
        #minigame-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .minigame-container {
            background: linear-gradient(145deg, #1e3c72, #2a5298);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            text-align: center;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        #minigame-prompt {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #ffffff;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        #minigame-grid {
            display: grid;
            gap: 4px;
            margin: 0 auto 20px;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
        }
        
        .minigame-grid-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 0 #2980b9;
        }
        
        .minigame-grid-btn:hover {
            background: #2980b9;
            transform: translateY(2px);
            box-shadow: 0 1px 0 #2980b9;
        }
        
        .minigame-grid-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }
        
        .minigame-grid-btn.revealed {
            background: #1a5276;
            transform: translateY(3px);
            box-shadow: none;
        }
        
        .minigame-grid-btn.flagged::after {
            content: "ğŸš©";
        }
        
        .minigame-grid-btn.water-source {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }
        
        .minigame-grid-btn.water-source::after {
            content: "ğŸ’§";
            font-size: 1.4rem;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #minigame-timer-container {
            width: 100%;
            height: 20px;
            background: #34495e;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #minigame-timer-bar {
            height: 100%;
            background: linear-gradient(to right, #2ecc71, #f1c40f, #e74c3c);
            width: 100%;
            transition: width 0.1s linear;
        }
        
        .game-result {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
        }
        
        .success {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .failure {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .instructions {
            background: rgba(30, 30, 60, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .instructions h2 {
            color: #4fc3f7;
            margin-bottom: 15px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .instructions li strong {
            color: #4fc3f7;
        }
        
        .counter {
            background: rgba(25, 25, 50, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }
        
        .counter span {
            margin-left: 8px;
            font-weight: bold;
            color: #4fc3f7;
        }
        
        @media (max-width: 700px) {
            .minigame-grid-btn {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }
            
            .counter {
                font-size: 1rem;
                padding: 8px 12px;
            }
            
            #minigame-prompt {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <script>
        (() => {
            const BGM_SRC = '../assets/audio/bgm/shuidi.ogg'; // â†æ”¹æˆä½ çš„è·¯å¾„
            const VOLUME = 0.1;
            let audio, ctx, source;

            function ensureAudio() {
                if (!audio) {
                    audio = new Audio(BGM_SRC);
                    audio.loop = true;
                    audio.volume = VOLUME;
                }
                return audio;
            }

            // å°è¯•ç”¨ <audio> ç›´æ¥æ’­ï¼›å¤±è´¥å†ç”¨ WebAudioâ€œè§£é”â€å…œåº•
            function tryPlay() {
                const a = ensureAudio();
                return a.play().catch(() => unlockViaGesture());
            }

            // WebAudio è§£é”å¥—è·¯ï¼ˆiOS å¸¸ç”¨ï¼‰ï¼šåœ¨ç”¨æˆ·æ‰‹åŠ¿å resume() å†æ’­æ”¾
            function unlockViaGesture() {
                try {
                    ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
                    if (ctx.state === 'suspended') return ctx.resume().then(() => ensureAudio().play());
                    return ensureAudio().play();
                } catch (e) {
                    showEnableButton();
                    return Promise.reject(e);
                }
            }

            function showEnableButton() {
                if (document.getElementById('enable-audio-btn')) return;
                const btn = document.createElement('button');
                btn.id = 'enable-audio-btn';
                btn.textContent = 'ç‚¹å‡»å¼€å¯éŸ³æ•ˆ';
                Object.assign(btn.style, {
                    position: 'fixed', right: '14px', bottom: '14px', zIndex: 2147483647,
                    padding: '10px 14px', borderRadius: '12px', border: '2px solid #000',
                    background: '#FFD400', color: '#000', fontWeight: '700', cursor: 'pointer'
                });
                btn.onclick = () => { unlockViaGesture().then(() => btn.remove()).catch(() => { }); };
                document.body.appendChild(btn);
            }

            // â€”â€” 1) é¡µé¢åŠ è½½å…ˆå°è¯•è‡ªåŠ¨æ’­æ”¾ï¼ˆChromium/æ¡Œé¢å¸¸èƒ½æˆåŠŸï¼‰
            tryPlay().catch(() => { /* è¢«æ‹¦æˆªå°±ç­‰å¾…æ‰‹åŠ¿ */ });

            // â€”â€” 2) ä¸€æ—¦å­é¡µé‡Œæœ‰æ‰‹åŠ¿å°±å†å°è¯•ï¼ˆç§»åŠ¨ç«¯å¸¸åœ¨è¿™é‡ŒæˆåŠŸï¼‰
            const startOnce = () => { tryPlay().finally(cleanup); };
            const cleanup = () => {
                document.removeEventListener('pointerdown', startOnce, true);
                document.removeEventListener('keydown', startOnce, true);
            };
            document.addEventListener('pointerdown', startOnce, true);
            document.addEventListener('keydown', startOnce, true);

            // â€”â€” 3) çˆ¶é¡µè½¬å‘çš„æ‰‹åŠ¿ï¼ˆåŒæº/å¸¸è§æµè§ˆå™¨é‡Œä¹Ÿæœ‰æ•ˆï¼‰
            window.addEventListener('message', (e) => {
                if (e?.data?.type === 'mg:primeAudio') tryPlay();
            });

            // é€€å‡ºæ—¶åœæ­¢
            function stop() { try { audio && (audio.pause(), audio.currentTime = 0); } catch { } }
            window.addEventListener('pagehide', stop);
            window.addEventListener('beforeunload', stop);

            // å¦‚æœä½ æœ‰ MG_DONE_* é’©å­ï¼ŒåŒ…ä¸€å±‚ç¡®ä¿é€€å‡ºå‰åœéŸ³
            ['MG_DONE_SUCCESS', 'MG_DONE_FAILURE'].forEach((name) => {
                const orig = window[name];
                if (typeof orig === 'function') {
                    window[name] = (...args) => { stop(); return orig.apply(window, args); };
                }
            });
        })();
    </script>

    <header>
        <h1>æ‰¾åˆ°å¹²å‡€çš„æ°´æºï¼</h1>
        <p class="subtitle">ä½¿ç”¨å£°æ³¢æ¢æµ‹æŠ€æœ¯å®šä½åœ°ä¸‹æ°´æº</p>
    </header>

    <div class="container">
        <div class="game-info">
            <div class="info-card">
                <h3>æ¸¸æˆç›®æ ‡</h3>
                <p>ä½¿ç”¨å£°æ³¢æ¢æµ‹æŠ€æœ¯ï¼Œå‡†ç¡®æ ‡è®°æ‰€æœ‰åœ°ä¸‹æ°´æºä½ç½®ã€‚é¿å…ç›´æ¥æ¢æµ‹åˆ°æ°´æºï¼Œå¦åˆ™ä¼šå¼•å‘äº‹æ•…ï¼</p>
            </div>
            <div class="info-card">
                <h3>æ¸¸æˆè§„åˆ™</h3>
                <p>å·¦é”®æ¢æµ‹åœ°å—ï¼Œå³é”®æ ‡è®°æ°´æºã€‚æ•°å­—è¡¨ç¤ºå‘¨å›´8æ ¼ä¸­çš„æ°´æºæ•°é‡ã€‚æ¢æµ‹åˆ°ç©ºç™½åŒºåŸŸä¼šè‡ªåŠ¨æ‰©å±•ã€‚</p>
            </div>
        </div>

        <div class="controls">
            <button id="start-game">å¼€å§‹æ¢æµ‹æ°´æº</button>
        </div>

        <div class="instructions">
            <h2>æ¸¸æˆæŒ‡å—</h2>
            <ul>
                <li><strong>å·¦é”®ç‚¹å‡»</strong> - æ¢æµ‹å½“å‰åœ°å—ï¼Œæ˜¾ç¤ºå‘¨å›´æ°´æºæ•°é‡</li>
                <li><strong>å³é”®ç‚¹å‡»</strong> - æ ‡è®°/å–æ¶ˆæ ‡è®°å¯ç–‘æ°´æºä½ç½®</li>
                <li><strong>æ•°å­—å«ä¹‰</strong> - æ˜¾ç¤ºçš„æ•°å­—è¡¨ç¤ºå‘¨å›´8ä¸ªåœ°å—ä¸­çš„æ°´æºæ•°é‡</li>
                <li><strong>è‡ªåŠ¨æ‰©å±•</strong> - æ¢æµ‹åˆ°ç©ºç™½åŒºåŸŸä¼šè‡ªåŠ¨æ‰©å±•æ­ç¤ºç›¸è¿åŒºåŸŸ</li>
                <li><strong>èƒœåˆ©æ¡ä»¶</strong> - å‡†ç¡®æ ‡è®°æ‰€æœ‰æ°´æºä½ç½®</li>
                <li><strong>å¤±è´¥æ¡ä»¶</strong> - ç›´æ¥æ¢æµ‹åˆ°æ°´æºæˆ–æ—¶é—´è€—å°½</li>
            </ul>
        </div>
    </div>

    <!-- å°æ¸¸æˆè¦†ç›–å±‚ -->
    <div id="minigame-overlay">
        <div class="minigame-container">
            <div class="game-header">
                <div class="counter">æ°´æºæ•°é‡: <span id="water-counter">20</span></div>
                <div class="counter">å‰©ä½™æ—¶é—´: <span id="time-counter">180</span>ç§’</div>
                <button id="skip-btn" style="display:none;">è·³è¿‡æœ¬å…³ï¼ˆåˆ¤æˆåŠŸï¼‰</button>
            </div>
            <div id="minigame-prompt">å‡†å¤‡å¼€å§‹æ¢æµ‹ï¼è¯·æ ‡è®°æ‰€æœ‰æ°´æºä½ç½®</div>
            <div id="minigame-timer-container">
                <div id="minigame-timer-bar"></div>
            </div>
            <div id="minigame-grid"></div>
        </div>
    </div>


    <script>
        /* == ç‚¹å‡»éŸ³æ•ˆï¼ˆå…¨å±€å¯ç”¨ï¼Œå¸¦éŸ³é¢‘æ± é¿å…å»¶è¿Ÿ/å éŸ³ï¼‰ == */
        const PLAY_CLICK = (() => {
            const SRC = '../assets/audio/se/shuidi.ogg';   // â† æ¢æˆä½ çš„éŸ³æ•ˆæ–‡ä»¶è·¯å¾„
            const VOLUME = 1;                          // 0~1ï¼ŒæŒ‰éœ€è¦å¾®è°ƒ
            const POOL = 8;                               // æœ€å¤šåŒæ—¶é‡å çš„ç‚¹å‡»æ•°
            const pool = Array.from({ length: POOL }, () => {
                const a = new Audio(SRC);
                a.preload = 'auto';
                a.volume = VOLUME;
                return a;
            });
            let i = 0;
            return () => {
                const a = pool[i++ % POOL];
                try { a.currentTime = 0; a.play(); } catch { }
            };
        })();
        /* â€”â€” åµŒå…¥/å‚æ•°ä¸Šä¸‹æ–‡ â€”â€” */
        const __URL = new URL(location.href);
        const __P = __URL.searchParams;

        // æ˜¯å¦åµŒå…¥ï¼ˆä»»æ„ä¸€ä¸ªä¸º 1 å³è§†ä¸ºåµŒå…¥ï¼‰
        const __EMBED = (__P.get('embed') === '1');       // ä»…è¡¨ç¤ºè¢«åµŒå…¥
        const __AUTOSTART = (__P.get('autostart') === '1');   // æ˜¯å¦è‡ªåŠ¨å¼€å§‹

        // æ˜¯å¦å…è®¸è·³è¿‡
        const __ALLOW_SKIP = (__P.get('allowSkip') === '1');
        // çˆ¶é¡µé¢ Originï¼ˆåé¢ postMessage ç”¨ï¼›æœ¬åœ°è°ƒè¯•å…ˆç”¨ *ï¼Œæ¥å…¥ä¸»å·¥ç¨‹æ—¶ä¼šæ”¹æˆå…·ä½“åŸŸï¼‰
        const __PARENT_ORIGIN = __P.get('parentOrigin') || '*';

        // å¯é€‰éš¾åº¦å‚æ•°ï¼ˆä¿ç•™å°†æ¥æ‰©å±•ï¼‰
        const __SIZE = parseInt(__P.get('size') || '') || null;
        const __COUNT = parseInt(__P.get('count') || '') || null;
        const __TIME = parseInt(__P.get('time') || '') || null;
        class MiniGameManager {
            constructor() {
                this.overlay = document.getElementById('minigame-overlay');
                this.promptEl = document.getElementById('minigame-prompt');
                this.gridEl = document.getElementById('minigame-grid');
                this.timerContainerEl = document.getElementById('minigame-timer-container');
                this.timerBarEl = document.getElementById('minigame-timer-bar');
                this.waterCounterEl = document.getElementById('water-counter');
                this.timeCounterEl = document.getElementById('time-counter');

                this.gameResolve = null;
                this.gameLogic = null;
                this.timerInterval = null;
            }

            show(gameName, params) {
                this.overlay.classList.add('visible');
                this.gridEl.hidden = false;
                this.timerContainerEl.style.visibility = 'visible';

                if (gameName === 'water_finder') {
                    this.gameLogic = this._runWaterFinderGame(params);
                }
                else {
                    console.error(`Unknown minigame: ${gameName}`);
                    return Promise.resolve('failure');
                }

                return new Promise(resolve => {
                    this.gameResolve = resolve;
                });
            }

            hide() {
                this.overlay.classList.remove('visible');
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                if (this.gameLogic && this.gameLogic.cleanup) {
                    this.gameLogic.cleanup();
                }
            }

            _endGame(result) {
                // 1) å…ˆæŠŠ Promise è§£å†³æ‰ï¼ˆå†…éƒ¨ç”¨ï¼‰
                if (this.gameResolve) {
                    this.gameResolve(result);
                    this.gameResolve = null;
                }

                // 2) å…ˆåœ¨é¡µé¢é‡Œæ˜¾ç¤ºâ€œç»“æœæç¤ºâ€ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
                const resultEl = document.createElement('div');
                resultEl.className = `game-result ${result === 'success' ? 'success' : 'failure'}`;
                resultEl.textContent = result === 'success' ? 'ä»»åŠ¡æˆåŠŸï¼æ°´æºå·²å®šä½ï¼' : 'ä»»åŠ¡å¤±è´¥ï¼æ°´æºæœªè·å–ï¼';
                // æŠŠæç¤ºæ’åœ¨ç½‘æ ¼å®¹å™¨åé¢ï¼ˆä½ åŸæ¥ä¹Ÿæ˜¯è¿™ä¹ˆæ”¾çš„ï¼‰
                this.gridEl.parentNode.insertBefore(resultEl, this.gridEl.nextSibling);

                // 3) è¿‡ä¸€å°æ®µæ—¶é—´å†é€šçŸ¥çˆ¶é¡µé¢å…³é—­ iframeï¼ˆè®©ç©å®¶çœ‹å¾—åˆ°æç¤ºï¼‰
                const DELAY_MS = 1500; // å¯æŒ‰éœ€è°ƒ 1200~2000
                try {
                    if (window.parent && window.parent !== window) {
                        setTimeout(() => {
                            try {
                                window.parent.postMessage(
                                    { type: 'mg:done', id: 'water-finder', result },
                                    __PARENT_ORIGIN
                                );
                            } catch (e) { /* å¿½ç•¥è·¨åŸŸç­‰å¼‚å¸¸ */ }
                        }, DELAY_MS);
                    }
                } catch (e) {
                    // å¿½ç•¥
                }

                // 4) åŸæœ‰çš„æ”¶å°¾ï¼šç»™è¶³æ˜¾ç¤ºæ—¶é—´åæŠŠæœ¬é¡µå†…å®¹æ”¶èµ·
                // ï¼ˆçˆ¶é¡µæ”¶åˆ°æ¶ˆæ¯å…³é—­ iframe åï¼Œè¿™æ®µå³ä½¿æ‰§è¡Œä¸åˆ°ä¹Ÿæ²¡å…³ç³»ï¼‰
                setTimeout(() => {
                    this.hide();
                    if (resultEl.parentNode) {
                        resultEl.parentNode.removeChild(resultEl);
                    }
                }, 2500);
            }


            // --- æ¸¸æˆé€»è¾‘: æ°´æºæ¢æµ‹ (æ‰«é›·å˜ä½“) ---
            _runWaterFinderGame(params) {
                this.gridEl.innerHTML = '';

                const size = 12; // å›ºå®š12x12æ£‹ç›˜
                const waterSourcesCount = 20; // å›ºå®š20ä¸ªæ°´æº
                let remainingFlags = waterSourcesCount;
                const timeLimit = 180; // ç§’

                this.waterCounterEl.textContent = remainingFlags;
                this.timeCounterEl.textContent = timeLimit;
                this.promptEl.textContent = `æ¢æµ‹å¼€å§‹ï¼è¯·æ ‡è®° ${waterSourcesCount} ä¸ªæ°´æºä½ç½®`;

                this.gridEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
                const btnSize = Math.min(35, 600 / size);
                this.gridEl.style.width = `${size * (btnSize + 4)}px`;
                this.gridEl.style.height = `${size * (btnSize + 4)}px`;

                const board = Array(size * size).fill(0);
                const waterLocations = new Set();

                // éšæœºç”Ÿæˆæ°´æºä½ç½®
                while (waterLocations.size < waterSourcesCount) {
                    const randomIndex = Math.floor(Math.random() * board.length);
                    waterLocations.add(randomIndex);
                }

                // è·å–ç›¸é‚»æ ¼å­ç´¢å¼•
                const getNeighbors = (index) => {
                    const neighbors = [];
                    const x = index % size;
                    const y = Math.floor(index / size);

                    for (let i = -1; i <= 1; i++) {
                        for (let j = -1; j <= 1; j++) {
                            if (i === 0 && j === 0) continue;

                            const newX = x + j;
                            const newY = y + i;

                            if (newX >= 0 && newX < size && newY >= 0 && newY < size) {
                                neighbors.push(newY * size + newX);
                            }
                        }
                    }
                    return neighbors;
                };

                // è®¡ç®—æ¯ä¸ªæ ¼å­çš„æ°´æºæ•°é‡
                const waterCounts = Array(size * size).fill(0);
                for (let i = 0; i < board.length; i++) {
                    if (waterLocations.has(i)) {
                        waterCounts[i] = -1; // æ°´æºä½ç½®æ ‡è®°ä¸º-1
                    } else {
                        const neighbors = getNeighbors(i);
                        waterCounts[i] = neighbors.filter(n => waterLocations.has(n)).length;
                    }
                }

                const buttons = [];
                let gameActive = true;

                // åˆ›å»ºæ¸¸æˆæ ¼å­
                for (let i = 0; i < board.length; i++) {
                    const button = document.createElement('button');
                    button.className = 'minigame-grid-btn water-game';
                    button.dataset.index = i;
                    button.style.width = `${btnSize}px`;
                    button.style.height = `${btnSize}px`;

                    // å·¦é”®ç‚¹å‡»äº‹ä»¶
                    button.addEventListener('click', () => {
                        PLAY_CLICK(); 
                        if (!gameActive || button.classList.contains('revealed') || button.classList.contains('flagged')) return;

                        if (waterLocations.has(i)) {
                            // ç‚¹åˆ°æ°´æº
                            button.classList.add('water-source');
                            this.promptEl.textContent = `è‡´å‘½é”™è¯¯ï¼ç›´æ¥è§¦ç¢°åˆ°äº†é«˜å‹æ°´è„‰ï¼`;
                            revealAll();
                            gameActive = false;
                            this._endGame('failure');
                            return;
                        }

                        // æ­ç¤ºæ ¼å­
                        revealCell(i);

                        // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
                        checkWinCondition();
                    });

                    // å³é”®ç‚¹å‡»äº‹ä»¶
                    button.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        PLAY_CLICK(); 
                        if (!gameActive || button.classList.contains('revealed')) return;

                        if (button.classList.contains('flagged')) {
                            button.classList.remove('flagged');
                            remainingFlags++;
                        } else if (remainingFlags > 0) {
                            button.classList.add('flagged');
                            remainingFlags--;
                        }

                        this.waterCounterEl.textContent = remainingFlags;
                        checkWinCondition();
                    });

                    this.gridEl.appendChild(button);
                    buttons.push(button);
                }

                // æ­ç¤ºæ ¼å­çš„å‡½æ•°ï¼ˆé€’å½’å®ç°è‡ªåŠ¨æ‰©å±•ï¼‰
                const revealCell = (index) => {
                    const button = buttons[index];

                    if (button.classList.contains('revealed') || waterLocations.has(index)) {
                        return;
                    }

                    button.classList.add('revealed');
                    const count = waterCounts[index];

                    if (count > 0) {
                        button.textContent = count;
                        // æ ¹æ®æ•°å­—è®¾ç½®ä¸åŒé¢œè‰²
                        const colors = ['#2ecc71', '#3498db', '#e74c3c', '#9b59b6', '#f39c12', '#1abc9c', '#34495e', '#7f8c8d'];
                        button.style.color = colors[count - 1] || '#ffffff';
                    } else {
                        // å¦‚æœæ˜¯ç©ºç™½æ ¼å­ï¼Œé€’å½’æ­ç¤ºç›¸é‚»æ ¼å­
                        const neighbors = getNeighbors(index);
                        neighbors.forEach(neighborIndex => {
                            if (!buttons[neighborIndex].classList.contains('revealed')) {
                                revealCell(neighborIndex);
                            }
                        });
                    }
                };

                // æ­ç¤ºæ‰€æœ‰æ ¼å­
                const revealAll = () => {
                    buttons.forEach((button, index) => {
                        if (!button.classList.contains('revealed')) {
                            if (waterLocations.has(index)) {
                                button.classList.add('water-source');
                            } else if (button.classList.contains('flagged')) {
                                button.classList.add('incorrect-flag');
                            }
                        }
                    });
                };

                // æ£€æŸ¥èƒœåˆ©æ¡ä»¶
                const checkWinCondition = () => {
                    // æ£€æŸ¥æ‰€æœ‰æ°´æºæ˜¯å¦éƒ½è¢«æ ‡è®°
                    let allWaterFlagged = true;
                    waterLocations.forEach(index => {
                        if (!buttons[index].classList.contains('flagged')) {
                            allWaterFlagged = false;
                        }
                    });

                    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ ‡è®°
                    let noIncorrectFlags = true;
                    buttons.forEach((button, index) => {
                        if (button.classList.contains('flagged') && !waterLocations.has(index)) {
                            noIncorrectFlags = false;
                        }
                    });

                    if (allWaterFlagged && noIncorrectFlags) {
                        this.promptEl.textContent = 'æˆåŠŸï¼æ‰€æœ‰æ°´æºéƒ½å·²å®šä½ï¼';
                        revealAll();
                        gameActive = false;
                        this._endGame('success');
                    }
                };

                // è®¡æ—¶å™¨åŠŸèƒ½
                this.timerContainerEl.style.visibility = 'visible';
                let timeLeft = timeLimit;
                this.timerBarEl.style.width = '100%';

                this.timerInterval = setInterval(() => {
                    timeLeft -= 0.1;
                    this.timeCounterEl.textContent = Math.ceil(timeLeft);
                    this.timerBarEl.style.width = `${(timeLeft / timeLimit) * 100}%`;

                    if (timeLeft <= 0) {
                        clearInterval(this.timerInterval);
                        this.promptEl.textContent = 'æ—¶é—´è€—å°½ï¼';
                        revealAll();
                        gameActive = false;
                        this._endGame('failure');
                    }
                }, 100);

                return {
                    cleanup: () => {
                        if (this.timerInterval) {
                            clearInterval(this.timerInterval);
                        }
                    }
                };
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const gameManager = new MiniGameManager();

            // è·³è¿‡æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘ï¼ˆä½ å·²æœ‰ï¼Œä¿ç•™ï¼‰
            const skipBtn = document.getElementById('skip-btn');
            if (skipBtn) {
                if (__ALLOW_SKIP) {
                    skipBtn.style.display = '';
                    skipBtn.addEventListener('click', () => gameManager._endGame('success'));
                } else {
                    skipBtn.style.display = 'none';
                }
            }

            const startBtn = document.getElementById('start-game');
            const header = document.querySelector('header');
            const introBox = document.querySelector('.container');

            if (__AUTOSTART) {
                // ä»…åœ¨æ˜¾å¼è¯·æ±‚è‡ªåŠ¨å¼€å§‹æ—¶ï¼šéšè—ä»‹ç»å¹¶ç›´æ¥å¼€å±€
                if (startBtn) startBtn.style.display = 'none';
                if (header) header.style.display = 'none';
                if (introBox) introBox.style.display = 'none';

                gameManager.show('water_finder').then(res => {
                    console.log('[embed:auto] æ¸¸æˆç»“æŸ =', res);
                });
            } else {
                // æ— è®ºæ˜¯å¦åµŒå…¥ï¼Œéƒ½ä¿ç•™ä»‹ç»ä¸â€œå¼€å§‹â€æŒ‰é’®ï¼Œç”¨æˆ·ç‚¹å‡»åå†è¿›å…¥
                if (startBtn) {
                    startBtn.addEventListener('click', () => {
                        gameManager.show('water_finder').then(res => {
                            console.log('[start] æ¸¸æˆç»“æŸ =', res);
                        });
                    });
                }
            }
        });


    </script>
</body>
</html>