<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯†å®¤é€ƒè„± - è§£å¯†å°æ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- é…ç½®Tailwindè‡ªå®šä¹‰é¢œè‰² -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#EC4899',
                        accent: '#F59E0B',
                        dark: '#1F2937',
                        light: '#F9FAFB'
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .room-object {
                @apply cursor-pointer transition-all duration-300 hover:scale-105 hover:brightness-110;
            }

            .puzzle-item {
                @apply bg-dark/80 rounded-lg p-4 mb-4 border border-gray-700;
            }

            .clue {
                @apply text-sm text-gray-400 italic mt-2;
            }

            .modal-backdrop {
                @apply fixed inset-0 bg-black/70 z-40 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-opacity duration-300;
            }

                .modal-backdrop.active {
                    @apply opacity-100 pointer-events-auto;
                }

            .modal-content {
                @apply bg-gray-900 rounded-lg shadow-2xl max-w-md w-full transform scale-95 transition-transform duration-300;
            }

            .modal-backdrop.active .modal-content {
                @apply scale-100;
            }

            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }

            .item-highlight {
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
                }

                70% {
                    box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);
                }

                100% {
                    box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);
                }
            }
        }
    </style>
    <style>
        #success-modal #play-again {
            display: none !important
        }
    </style>

</head>
<body class="bg-gray-900 text-light min-h-screen">
    <script>
        (() => {
            const BGM_SRC = '../assets/audio/bgm/mishi.ogg'; // â†æ”¹æˆä½ çš„è·¯å¾„
            const VOLUME = 0.55;
            let audio, ctx, source;

            function ensureAudio() {
                if (!audio) {
                    audio = new Audio(BGM_SRC);
                    audio.loop = true;
                    audio.volume = VOLUME;
                }
                return audio;
            }

            // å°è¯•ç”¨ <audio> ç›´æ¥æ’­ï¼›å¤±è´¥å†ç”¨ WebAudioâ€œè§£é”â€å…œåº•
            function tryPlay() {
                const a = ensureAudio();
                return a.play().catch(() => unlockViaGesture());
            }

            // WebAudio è§£é”å¥—è·¯ï¼ˆiOS å¸¸ç”¨ï¼‰ï¼šåœ¨ç”¨æˆ·æ‰‹åŠ¿å resume() å†æ’­æ”¾
            function unlockViaGesture() {
                try {
                    ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
                    if (ctx.state === 'suspended') return ctx.resume().then(() => ensureAudio().play());
                    return ensureAudio().play();
                } catch (e) {
                    showEnableButton();
                    return Promise.reject(e);
                }
            }

            function showEnableButton() {
                if (document.getElementById('enable-audio-btn')) return;
                const btn = document.createElement('button');
                btn.id = 'enable-audio-btn';
                btn.textContent = 'ç‚¹å‡»å¼€å¯éŸ³æ•ˆ';
                Object.assign(btn.style, {
                    position: 'fixed', right: '14px', bottom: '14px', zIndex: 2147483647,
                    padding: '10px 14px', borderRadius: '12px', border: '2px solid #000',
                    background: '#FFD400', color: '#000', fontWeight: '700', cursor: 'pointer'
                });
                btn.onclick = () => { unlockViaGesture().then(() => btn.remove()).catch(() => { }); };
                document.body.appendChild(btn);
            }

            // â€”â€” 1) é¡µé¢åŠ è½½å…ˆå°è¯•è‡ªåŠ¨æ’­æ”¾ï¼ˆChromium/æ¡Œé¢å¸¸èƒ½æˆåŠŸï¼‰
            tryPlay().catch(() => { /* è¢«æ‹¦æˆªå°±ç­‰å¾…æ‰‹åŠ¿ */ });

            // â€”â€” 2) ä¸€æ—¦å­é¡µé‡Œæœ‰æ‰‹åŠ¿å°±å†å°è¯•ï¼ˆç§»åŠ¨ç«¯å¸¸åœ¨è¿™é‡ŒæˆåŠŸï¼‰
            const startOnce = () => { tryPlay().finally(cleanup); };
            const cleanup = () => {
                document.removeEventListener('pointerdown', startOnce, true);
                document.removeEventListener('keydown', startOnce, true);
            };
            document.addEventListener('pointerdown', startOnce, true);
            document.addEventListener('keydown', startOnce, true);

            // â€”â€” 3) çˆ¶é¡µè½¬å‘çš„æ‰‹åŠ¿ï¼ˆåŒæº/å¸¸è§æµè§ˆå™¨é‡Œä¹Ÿæœ‰æ•ˆï¼‰
            window.addEventListener('message', (e) => {
                if (e?.data?.type === 'mg:primeAudio') tryPlay();
            });

            // é€€å‡ºæ—¶åœæ­¢
            function stop() { try { audio && (audio.pause(), audio.currentTime = 0); } catch { } }
            window.addEventListener('pagehide', stop);
            window.addEventListener('beforeunload', stop);

            // å¦‚æœä½ æœ‰ MG_DONE_* é’©å­ï¼ŒåŒ…ä¸€å±‚ç¡®ä¿é€€å‡ºå‰åœéŸ³
            ['MG_DONE_SUCCESS', 'MG_DONE_FAILURE'].forEach((name) => {
                const orig = window[name];
                if (typeof orig === 'function') {
                    window[name] = (...args) => { stop(); return orig.apply(window, args); };
                }
            });
        })();
    </script>

    <!-- æ¸¸æˆæ ‡é¢˜å’ŒçŠ¶æ€ -->
    <header class="bg-dark/80 p-4 text-center">
        <h1 class="text-2xl md:text-3xl font-bold text-primary mb-2">å¯†å®¤é€ƒè„±</h1>
        <p class="text-gray-400">å¯»æ‰¾çº¿ç´¢ï¼Œç ´è§£è°œé¢˜ï¼Œé€ƒå‡ºæˆ¿é—´</p>
        <div class="flex justify-center mt-3 space-x-4">
            <div class="flex items-center">
                <i class="fa fa-key text-accent mr-2"></i>
                <span>æ‰¾åˆ°çš„é’¥åŒ™: <span id="keys-found" class="font-bold text-accent">0</span>/1</span>
            </div>
            <div class="flex items-center">
                <i class="fa fa-lightbulb-o text-secondary mr-2"></i>
                <span>çº¿ç´¢: <span id="clues-found" class="font-bold text-secondary">0</span>/3</span>
            </div>
        </div>
    </header>

    <!-- æ¸¸æˆä¸»åŒºåŸŸ -->
    <main class="container mx-auto p-4 md:p-6 max-w-5xl">
        <!-- æˆ¿é—´åœºæ™¯ -->
        <div id="room" class="relative bg-gray-800 rounded-xl overflow-hidden mb-6 h-[500px]">
            <img src="https://picsum.photos/id/174/1200/800" alt="å¯†å®¤å†…éƒ¨åœºæ™¯" class="w-full h-full object-cover opacity-70">

            <!-- å¯äº¤äº’ç‰©å“ -->
            <div id="painting" class="room-object absolute top-[10%] left-[20%] w-[200px] h-[250px] border-2 border-gray-300" data-item="painting">
                <img src="https://picsum.photos/id/96/400/500" alt="å¢™ä¸Šçš„ç”»" class="w-full h-full object-cover">
            </div>

            <div id="desk" class="room-object absolute top-[50%] left-[60%] w-[220px] h-[180px] bg-brown-800/80 rounded" data-item="desk">
                <div class="p-2">
                    <div id="locked-box" class="room-object w-[80px] h-[80px] bg-gray-700 rounded-md mt-2 ml-2 border-2 border-accent/50" data-item="locked-box">
                        <div class="w-full h-full flex items-center justify-center">
                            <i class="fa fa-lock text-accent"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="bookshelf" class="room-object absolute top-[30%] left-[70%] w-[150px] h-[280px] bg-brown-700/70" data-item="bookshelf">
                <div class="p-2 grid grid-cols-3 gap-1 h-full">
                    <div class="bg-red-700 rounded-sm"></div>
                    <div class="bg-blue-700 rounded-sm"></div>
                    <div class="bg-green-700 rounded-sm"></div>
                    <div class="bg-yellow-700 rounded-sm"></div>
                    <div class="bg-purple-700 rounded-sm"></div>
                    <div class="bg-pink-700 rounded-sm"></div>
                    <div class="bg-indigo-700 rounded-sm"></div>
                    <div class="bg-teal-700 rounded-sm"></div>
                    <div class="bg-orange-700 rounded-sm"></div>
                </div>
            </div>

            <div id="door" class="room-object absolute top-[25%] right-[5%] w-[100px] h-[300px] bg-gray-700/90 border-4 border-gray-600" data-item="door">
                <div class="w-full h-full flex flex-col items-center justify-center">
                    <div id="door-lock" class="w-[40px] h-[60px] bg-gray-600 rounded-md mt-4" data-item="door-lock">
                        <div class="w-full h-full flex items-center justify-center">
                            <i class="fa fa-lock text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="clock" class="room-object absolute top-[15%] right-[30%] w-[120px] h-[120px] rounded-full bg-gray-700/80 border-4 border-gray-600" data-item="clock">
                <div class="w-full h-full flex items-center justify-center">
                    <span id="clock-time" class="text-xl font-bold">17:45</span>
                </div>
            </div>

            <!-- ç‰©å“æç¤ºç‚¹ -->
            <div class="absolute top-[10%] left-[20%] w-[200px] h-[250px] pointer-events-none">
                <div class="hidden" id="painting-highlight">
                    <i class="fa fa-hand-pointer-o absolute -top-6 -right-6 text-2xl text-primary item-highlight"></i>
                </div>
            </div>
        </div>

        <!-- ç©å®¶ç‰©å“æ  -->
        <div class="puzzle-item">
            <h2 class="text-xl font-bold mb-3 flex items-center">
                <i class="fa fa-briefcase text-primary mr-2"></i> ç‰©å“æ 
            </h2>
            <div id="inventory" class="flex flex-wrap gap-3">
                <div class="text-gray-500 italic">ä½ çš„ç‰©å“å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            </div>
        </div>

        <!-- ç¬”è®°/çº¿ç´¢åŒº -->
        <div class="puzzle-item">
            <h2 class="text-xl font-bold mb-3 flex items-center">
                <i class="fa fa-book text-secondary mr-2"></i> ç¬”è®°
            </h2>
            <div id="notes" class="space-y-3 text-gray-300">
                <div class="text-gray-500 italic">ä½ å‘ç°çš„çº¿ç´¢å°†è®°å½•åœ¨è¿™é‡Œ...</div>
            </div>
        </div>
    </main>

    <!-- è°œé¢˜æ¨¡æ€æ¡† -->
    <div id="painting-modal" class="modal-backdrop">
        <div class="modal-content p-5">
            <h3 class="text-xl font-bold text-primary mb-3">å¢™ä¸Šçš„ç”»</h3>
            <div class="mb-4">
                <img src="https://picsum.photos/id/96/600/700" alt="ä¸€å¹…é£æ™¯ç”»" class="w-full h-auto rounded-md">
                <p class="clue">ç”»æ¡†ä¼¼ä¹æœ‰äº›æ¾åŠ¨...</p>
            </div>
            <div class="flex justify-end">
                <button class="close-modal bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded mr-2">æŸ¥çœ‹</button>
                <button id="remove-painting" class="bg-primary hover:bg-primary/80 px-4 py-2 rounded">å–ä¸‹ç”»æ¡†</button>
            </div>
        </div>
    </div>

    <div id="safe-modal" class="modal-backdrop">
        <div class="modal-content p-5">
            <h3 class="text-xl font-bold text-accent mb-3">å¸¦å¯†ç çš„ç›’å­</h3>
            <p class="mb-4">è¿™æ˜¯ä¸€ä¸ªéœ€è¦4ä½æ•°å­—å¯†ç æ‰èƒ½æ‰“å¼€çš„ç›’å­</p>
            <div class="mb-4">
                <input type="text" id="safe-code" maxlength="4" placeholder="è¾“å…¥4ä½æ•°å­—å¯†ç "
                       class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-center text-xl">
                <p class="clue">æç¤º: æ—¶é—´å¯èƒ½æ˜¯å…³é”®</p>
            </div>
            <div class="flex justify-end">
                <button class="close-modal bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded mr-2">å…³é—­</button>
                <button id="open-safe" class="bg-accent hover:bg-accent/80 px-4 py-2 rounded">æ‰“å¼€</button>
            </div>
        </div>
    </div>

    <div id="bookshelf-modal" class="modal-backdrop">
        <div class="modal-content p-5">
            <h3 class="text-xl font-bold text-secondary mb-3">ä¹¦æ¶</h3>
            <p class="mb-4">ä¹¦æ¶ä¸Šæ’åˆ—ç€ä¸åŒé¢œè‰²çš„ä¹¦ï¼Œä¼¼ä¹å¯ä»¥æŒ‰åŠ¨</p>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="color-book bg-red-700 w-full h-10 rounded-sm cursor-pointer" data-color="red"></div>
                <div class="color-book bg-blue-700 w-full h-10 rounded-sm cursor-pointer" data-color="blue"></div>
                <div class="color-book bg-green-700 w-full h-10 rounded-sm cursor-pointer" data-color="green"></div>
                <div class="color-book bg-yellow-700 w-full h-10 rounded-sm cursor-pointer" data-color="yellow"></div>
                <div class="color-book bg-purple-700 w-full h-10 rounded-sm cursor-pointer" data-color="purple"></div>
                <div class="color-book bg-pink-700 w-full h-10 rounded-sm cursor-pointer" data-color="pink"></div>
                <div class="color-book bg-indigo-700 w-full h-10 rounded-sm cursor-pointer" data-color="indigo"></div>
                <div class="color-book bg-teal-700 w-full h-10 rounded-sm cursor-pointer" data-color="teal"></div>
                <div class="color-book bg-orange-700 w-full h-10 rounded-sm cursor-pointer" data-color="orange"></div>
            </div>
            <p id="color-sequence" class="text-center mb-2 h-6"></p>
            <p class="clue">æç¤º: å°è¯•æŒ‰ç‰¹å®šé¡ºåºæŒ‰ä¸‹ä¸åŒé¢œè‰²çš„ä¹¦</p>
            <div class="flex justify-end">
                <button class="close-modal bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">å…³é—­</button>
            </div>
        </div>
    </div>

    <div id="door-lock-modal" class="modal-backdrop">
        <div class="modal-content p-5">
            <h3 class="text-xl font-bold mb-3">é—¨é”</h3>
            <p id="door-lock-message" class="mb-4">é—¨æ˜¯é”ç€çš„ï¼Œä½ éœ€è¦æ‰¾åˆ°é’¥åŒ™æ‰èƒ½æ‰“å¼€</p>
            <div id="use-key-container" class="hidden mb-4">
                <button id="use-key" class="w-full bg-accent hover:bg-accent/80 px-4 py-2 rounded flex items-center justify-center">
                    <i class="fa fa-key mr-2"></i> ä½¿ç”¨é’¥åŒ™å¼€é—¨
                </button>
            </div>
            <div class="flex justify-end">
                <button class="close-modal bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- èƒœåˆ©æ¨¡æ€æ¡† -->
    <div id="success-modal" class="modal-backdrop">
        <div class="modal-content p-6 text-center">
            <div class="text-6xl text-accent mb-4">
                <i class="fa fa-trophy"></i>
            </div>
            <h2 class="text-2xl font-bold mb-3">æ­å–œä½ æˆåŠŸé€ƒè„±ï¼</h2>
            <p class="mb-6">ä½ æˆåŠŸè§£å¼€äº†æ‰€æœ‰è°œé¢˜ï¼Œé€ƒå‡ºäº†å¯†å®¤ï¼</p>
            <button id="play-again" class="bg-primary hover:bg-primary/80 text-white font-bold py-3 px-6 rounded-lg">
                å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            inventory: [],
            clues: [],
            keysFound: 0,
            paintingRemoved: false,
            safeOpened: false,
            bookshelfSolved: false,
            correctColorSequence: ['red', 'blue', 'green', 'yellow'],
            currentColorSequence: []
        };

        // DOMå…ƒç´ 
        const elements = {
            // ç‰©å“å’Œè°œé¢˜å…ƒç´ 
            painting: document.getElementById('painting'),
            desk: document.getElementById('desk'),
            lockedBox: document.getElementById('locked-box'),
            bookshelf: document.getElementById('bookshelf'),
            door: document.getElementById('door'),
            doorLock: document.getElementById('door-lock'),
            clock: document.getElementById('clock'),
            paintingHighlight: document.getElementById('painting-highlight'),

            // çŠ¶æ€æ˜¾ç¤º
            keysFoundElement: document.getElementById('keys-found'),
            cluesFoundElement: document.getElementById('clues-found'),
            inventory: document.getElementById('inventory'),
            notes: document.getElementById('notes'),

            // æ¨¡æ€æ¡†
            paintingModal: document.getElementById('painting-modal'),
            safeModal: document.getElementById('safe-modal'),
            bookshelfModal: document.getElementById('bookshelf-modal'),
            doorLockModal: document.getElementById('door-lock-modal'),
            successModal: document.getElementById('success-modal'),

            // æ¨¡æ€æ¡†å†…å®¹
            safeCode: document.getElementById('safe-code'),
            colorSequence: document.getElementById('color-sequence'),
            doorLockMessage: document.getElementById('door-lock-message'),
            useKeyContainer: document.getElementById('use-key-container'),

            // æŒ‰é’®
            removePainting: document.getElementById('remove-painting'),
            openSafe: document.getElementById('open-safe'),
            useKey: document.getElementById('use-key'),
            playAgain: document.getElementById('play-again'),
            closeModals: document.querySelectorAll('.close-modal')
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.inventory = [];
            gameState.clues = [];
            gameState.keysFound = 0;
            gameState.paintingRemoved = false;
            gameState.safeOpened = false;
            gameState.bookshelfSolved = false;
            gameState.currentColorSequence = [];

            // æ›´æ–°UI
            updateInventory();
            updateNotes();
            elements.keysFoundElement.textContent = '0';
            elements.cluesFoundElement.textContent = '0';
            elements.painting.style.display = 'block';
            elements.lockedBox.style.display = 'block';
            elements.colorSequence.textContent = '';
            elements.doorLockMessage.textContent = 'é—¨æ˜¯é”ç€çš„ï¼Œä½ éœ€è¦æ‰¾åˆ°é’¥åŒ™æ‰èƒ½æ‰“å¼€';
            elements.useKeyContainer.classList.add('hidden');

            // éšè—æ‰€æœ‰æ¨¡æ€æ¡†
            hideAllModals();

            // æ˜¾ç¤ºåˆå§‹æç¤º
            setTimeout(() => {
                elements.paintingHighlight.classList.remove('hidden');
            }, 1000);
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(modal) {
            modal.classList.add('active');
        }

        // éšè—æ¨¡æ€æ¡†
        function hideModal(modal) {
            modal.classList.remove('active');
        }

        // éšè—æ‰€æœ‰æ¨¡æ€æ¡†
        function hideAllModals() {
            document.querySelectorAll('.modal-backdrop').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        // æ·»åŠ ç‰©å“åˆ° inventory
        function addToInventory(itemName, iconClass) {
            // æ£€æŸ¥ç‰©å“æ˜¯å¦å·²å­˜åœ¨
            if (gameState.inventory.some(item => item.name === itemName)) {
                return;
            }

            const item = {
                name: itemName,
                icon: iconClass
            };

            gameState.inventory.push(item);
            updateInventory();

            // å¦‚æœæ˜¯é’¥åŒ™ï¼Œæ›´æ–°è®¡æ•°
            if (itemName === 'é’¥åŒ™') {
                gameState.keysFound++;
                elements.keysFoundElement.textContent = gameState.keysFound;
                elements.useKeyContainer.classList.remove('hidden');
            }
        }

        // æ›´æ–°ç‰©å“æ æ˜¾ç¤º
        function updateInventory() {
            if (gameState.inventory.length === 0) {
                elements.inventory.innerHTML = '<div class="text-gray-500 italic">ä½ çš„ç‰©å“å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>';
                return;
            }

            elements.inventory.innerHTML = '';
            gameState.inventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'bg-gray-800 p-2 rounded flex items-center';
                itemElement.innerHTML = `<i class="fa ${item.icon} text-accent mr-2"></i> ${item.name}`;
                elements.inventory.appendChild(itemElement);
            });
        }

        // æ·»åŠ çº¿ç´¢åˆ°ç¬”è®°
        function addClue(text) {
            // æ£€æŸ¥çº¿ç´¢æ˜¯å¦å·²å­˜åœ¨
            if (gameState.clues.includes(text)) {
                return;
            }

            gameState.clues.push(text);
            updateNotes();
            elements.cluesFoundElement.textContent = gameState.clues.length;
        }

        // æ›´æ–°ç¬”è®°æ˜¾ç¤º
        function updateNotes() {
            if (gameState.clues.length === 0) {
                elements.notes.innerHTML = '<div class="text-gray-500 italic">ä½ å‘ç°çš„çº¿ç´¢å°†è®°å½•åœ¨è¿™é‡Œ...</div>';
                return;
            }

            elements.notes.innerHTML = '';
            gameState.clues.forEach((clue, index) => {
                const clueElement = document.createElement('div');
                clueElement.className = 'fade-in';
                clueElement.innerHTML = `<p><span class="text-secondary font-bold">çº¿ç´¢ ${index + 1}:</span> ${clue}</p>`;
                elements.notes.appendChild(clueElement);
            });
        }

        // æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®
        function checkSafeCode() {
            const code = elements.safeCode.value;
            // æ­£ç¡®å¯†ç æ˜¯æ—¶é’Ÿæ˜¾ç¤ºçš„æ—¶é—´17:45è½¬æ¢çš„1745
            if (code === '1745') {
                // æ‰“å¼€ç›’å­ï¼Œæ·»åŠ é’¥åŒ™
                addToInventory('é’¥åŒ™', 'fa-key');
                addClue('ç›’å­é‡Œæœ‰ä¸€æŠŠé’¥åŒ™ï¼Œä¹Ÿè®¸å¯ä»¥ç”¨æ¥å¼€é—¨ã€‚');
                gameState.safeOpened = true;
                elements.lockedBox.innerHTML = '<div class="w-full h-full flex items-center justify-center"><i class="fa fa-unlock text-accent"></i></div>';
                hideModal(elements.safeModal);

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert('æ­å–œï¼ä½ æ‰“å¼€äº†ç›’å­ï¼Œè·å¾—äº†ä¸€æŠŠé’¥åŒ™ï¼');
                return true;
            } else {
                alert('å¯†ç ä¸æ­£ç¡®ï¼Œè¯·å†è¯•ä¸€æ¬¡ã€‚');
                return false;
            }
        }

        // æ£€æŸ¥é¢œè‰²åºåˆ—æ˜¯å¦æ­£ç¡®
        function checkColorSequence() {
            if (gameState.currentColorSequence.length !== gameState.correctColorSequence.length) {
                return false;
            }

            for (let i = 0; i < gameState.currentColorSequence.length; i++) {
                if (gameState.currentColorSequence[i] !== gameState.correctColorSequence[i]) {
                    return false;
                }
            }

            return true;
        }

        // å¤„ç†é¢œè‰²ä¹¦ç‚¹å‡»
        function handleColorBookClick(color) {
            gameState.currentColorSequence.push(color);

            // æ˜¾ç¤ºå½“å‰åºåˆ—
            const colorMap = {
                'red': 'ğŸ”´',
                'blue': 'ğŸ”µ',
                'green': 'ğŸŸ¢',
                'yellow': 'ğŸŸ¡',
                'purple': 'ğŸŸ£',
                'pink': 'ğŸ”˜',
                'indigo': 'ğŸ”·',
                'teal': 'ğŸŸ ',
                'orange': 'ğŸŸ '
            };

            elements.colorSequence.textContent = gameState.currentColorSequence.map(c => colorMap[c]).join(' ');

            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é•¿åº¦é™åˆ¶
            if (gameState.currentColorSequence.length > 4) {
                gameState.currentColorSequence = [];
                elements.colorSequence.textContent = 'åºåˆ—å¤ªé•¿ï¼Œå·²é‡ç½®';
                setTimeout(() => {
                    elements.colorSequence.textContent = '';
                }, 1500);
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æ­£ç¡®
            if (checkColorSequence()) {
                gameState.bookshelfSolved = true;
                addClue('ä¹¦æ¶åé¢æœ‰ä¸€å¼ çº¸æ¡ï¼Œä¸Šé¢å†™ç€ï¼š"è®°ä½æ—¶é—´ï¼Œå®ƒæ˜¯å…³é”®"ã€‚');
                alert('æ­å–œï¼ä½ è§£å¼€äº†ä¹¦æ¶è°œé¢˜ï¼Œå‘ç°äº†ä¸€æ¡çº¿ç´¢ï¼');
                hideModal(elements.bookshelfModal);
            }
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç‰©å“ç‚¹å‡»äº‹ä»¶
            elements.painting.addEventListener('click', () => {
                showModal(elements.paintingModal);
            });

            elements.lockedBox.addEventListener('click', () => {
                if (gameState.safeOpened) {
                    alert('ç›’å­å·²ç»æ‰“å¼€äº†ï¼Œé‡Œé¢çš„é’¥åŒ™å·²ç»è¢«æ‹¿èµ°ã€‚');
                } else {
                    showModal(elements.safeModal);
                }
            });

            elements.bookshelf.addEventListener('click', () => {
                showModal(elements.bookshelfModal);
            });

            elements.doorLock.addEventListener('click', () => {
                showModal(elements.doorLockModal);
            });

            // é¢œè‰²ä¹¦ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.color-book').forEach(book => {
                book.addEventListener('click', () => {
                    if (!gameState.bookshelfSolved) {
                        const color = book.getAttribute('data-color');
                        handleColorBookClick(color);
                    } else {
                        alert('ä½ å·²ç»è§£å¼€äº†è¿™ä¸ªè°œé¢˜ã€‚');
                    }
                });
            });

            // æŒ‰é’®äº‹ä»¶
            elements.removePainting.addEventListener('click', () => {
                elements.painting.style.display = 'none';
                gameState.paintingRemoved = true;
                addClue('ç”»åé¢æœ‰ä¸€ä¸ªé¢œè‰²åºåˆ—ï¼šçº¢ã€è“ã€ç»¿ã€é»„ã€‚');
                hideModal(elements.paintingModal);
                elements.paintingHighlight.classList.add('hidden');
            });

            elements.openSafe.addEventListener('click', checkSafeCode);

            elements.useKey.addEventListener('click', () => {
                if (gameState.keysFound > 0) {
                    hideModal(elements.doorLockModal);
                    // ç›´æ¥é€šå…³ï¼šä¸å†æ˜¾ç¤ºâ€œèƒœåˆ©æ¨¡æ€æ¡†â€ï¼Œç›´æ¥é€šçŸ¥çˆ¶é¡µæˆåŠŸ
                    if (window.MG_DONE_SUCCESS) {
                        setTimeout(() => window.MG_DONE_SUCCESS(), 300);
                    } else {
                        // å¦‚æœæ˜¯å•ç‹¬æ‰“å¼€çš„é¡µé¢ï¼ˆæ²¡æœ‰çˆ¶é¡µï¼‰ï¼Œä¿ç•™ä¸€ä¸ªç®€çŸ­æç¤ºåè‡ªåŠ¨åˆ·æ–°
                        alert('æ­å–œï¼ä½ æˆåŠŸé€ƒè„±ï¼');
                        // å¯é€‰ï¼šä¸æƒ³åˆ·æ–°å°±åˆ æ‰ä¸‹ä¸€è¡Œ
                        setTimeout(() => location.reload(), 600);
                    }
                }
            });


            elements.playAgain.addEventListener('click', () => {
                hideModal(elements.successModal);
                initGame();
            });

            // å…³é—­æ¨¡æ€æ¡†æŒ‰é’®
            elements.closeModals.forEach(button => {
                button.addEventListener('click', () => {
                    hideAllModals();
                });
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            document.querySelectorAll('.modal-backdrop').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal(modal);
                    }
                });
            });

            // é”®ç›˜äº‹ä»¶ - ESCå…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideAllModals();
                }
            });
        }

        // å¯åŠ¨æ¸¸æˆ
        window.addEventListener('load', () => {
            initGame();
            bindEvents();
        });

    </script>
    <script>
        /**
         * ä»…å®ç°ï¼š
         * 1) ?allowSkip=1 æ—¶æ˜¾ç¤ºâ€œè·³è¿‡ï¼ˆè§†ä¸ºæˆåŠŸï¼‰â€æŒ‰é’®
         * 2) ä¸çˆ¶é¡µé€šä¿¡ { type:'mg:done', id:'jimixiang', result:'success'|'failure'|'quit' }
         * æ³¨æ„ï¼šè·³è¿‡ = successï¼›å…¶ä½™ä¸æ”¹
         */
        (() => {
            const q = new URLSearchParams(location.search);
            const ALLOW_SKIP = q.get('allowSkip') === '1';
            const PARENT_ORIGIN = q.get('parentOrigin') || '*';
            const ID = 'jimixiang';

            let SENT = false;
            function notify(result) {
                if (SENT) return;
                SENT = true;
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({ type: 'mg:done', id: ID, result }, PARENT_ORIGIN);
                    }
                } catch (_) { }
            }

            // æš´éœ²å¯é€‰é’©å­ï¼ˆé¡µé¢å†…éƒ¨è‹¥æœ‰åˆ¤å®šä¹Ÿå¯è°ƒç”¨ï¼‰
            window.MG_DONE_SUCCESS = () => notify('success');
            window.MG_DONE_FAILURE = () => notify('failure');

            // â€”â€” é«˜å¯¹æ¯”åº¦â€œè·³è¿‡â€æŒ‰é’®ï¼ˆå…è®¸æ—¶æ‰æ˜¾ç¤ºï¼‰â€”â€”
            if (ALLOW_SKIP) {
                const btn = document.createElement('button');
                btn.textContent = 'è·³è¿‡ï¼ˆè§†ä¸ºæˆåŠŸï¼‰';

                // å¼ºå¯¹æ¯”+æè¾¹+åŒé˜´å½±ï¼Œå°½é‡åœ¨ä»»ä½•åº•å›¾ä¸Šéƒ½æ¸…æ™°
                Object.assign(btn.style, {
                    position: 'fixed',
                    top: '14px',
                    right: '14px',
                    zIndex: '2147483647',        // ç½®é¡¶
                    padding: '10px 14px',
                    borderRadius: '12px',
                    border: '2px solid #000',    // é»‘è‰²æè¾¹
                    background: '#FFD400',       // äº®é»„è‰²ï¼ˆå¯¹æ·±/æµ…åº•éƒ½æ˜¾çœ¼ï¼‰
                    color: '#000',               // é»‘å­—
                    fontSize: '15px',
                    fontWeight: '700',
                    letterSpacing: '0.5px',
                    boxShadow: '0 0 0 3px rgba(255,255,255,0.95), 0 3px 12px rgba(0,0,0,0.45)', // ç™½è‰²å¤–ç¯ + é˜´å½±
                    cursor: 'pointer',
                    userSelect: 'none',
                    transition: 'transform .08s ease, box-shadow .08s ease'
                });

                // æ‚¬åœ/æŒ‰ä¸‹çš„å¾®äº¤äº’ï¼Œä¿æŒå¯è§æ€§
                btn.addEventListener('mouseenter', () => {
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = '0 0 0 3px rgba(255,255,255,1), 0 6px 18px rgba(0,0,0,0.5)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'scale(1)';
                    btn.style.boxShadow = '0 0 0 3px rgba(255,255,255,0.95), 0 3px 12px rgba(0,0,0,0.45)';
                });
                btn.addEventListener('mousedown', () => (btn.style.transform = 'scale(0.98)'));
                btn.addEventListener('mouseup', () => (btn.style.transform = 'scale(1.05)'));

                // é”®ç›˜å¯è§ç„¦ç‚¹ï¼ˆå†åŠ ä¸€å±‚ç™½ç¯ï¼‰
                btn.addEventListener('focus', () => {
                    btn.style.boxShadow = '0 0 0 5px rgba(255,255,255,1), 0 6px 18px rgba(0,0,0,0.55)';
                    btn.style.outline = 'none';
                });
                btn.addEventListener('blur', () => {
                    btn.style.boxShadow = '0 0 0 3px rgba(255,255,255,0.95), 0 3px 12px rgba(0,0,0,0.45)';
                });

                btn.addEventListener('click', () => notify('success')); // è·³è¿‡=æˆåŠŸ
                document.body.appendChild(btn);
            }
        })();
    </script>


</body>
</html>